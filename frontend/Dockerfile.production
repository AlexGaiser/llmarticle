# Build stage
FROM node:20-alpine AS builder

WORKDIR /app

# Copy shared package
COPY shared ./shared

# Build shared package
WORKDIR /app/shared
RUN npm install
RUN npm run build

# Copy frontend package files
WORKDIR /app
COPY frontend/package*.json ./frontend/

# Install frontend dependencies
WORKDIR /app/frontend
RUN npm ci

# Copy frontend source and config
COPY frontend/tsconfig*.json ./
COPY frontend/vite.config.ts ./
COPY frontend/postcss.config.js ./
COPY frontend/tailwind.config.js ./
COPY frontend/index.html ./
COPY frontend/src ./src
COPY frontend/public ./public

# Build static assets
RUN npm run build

# Production stage
FROM nginx:alpine AS production

# Copy nginx configuration
COPY frontend/nginx.conf /etc/nginx/nginx.conf

# Copy built static files from builder
COPY --from=builder /app/frontend/dist /usr/share/nginx/html

EXPOSE 80 443

CMD ["nginx", "-g", "daemon off;"]
